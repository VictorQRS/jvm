#include <iostream>
#include <map>
#include "reader.hpp"
#include "attribute.hpp"

namespace jvm {
	AttributeInfo::AttributeInfo(Reader &reader) {
		Read(reader);
	}

	void AttributeInfo::printToStream(std::ostream &os, ConstantPool &cp, std::string tabs) {
		std::map<int, std::string> code {
			{ std::stoi("00110010", nullptr, 2), "aaload" },
			{ std::stoi("01010011", nullptr, 2), "aastore" },
			{ std::stoi("00000001", nullptr, 2), "aconst_null" },
			{ std::stoi("00011001", nullptr, 2), "aload" },
			{ std::stoi("00101010", nullptr, 2), "aload_0" },
			{ std::stoi("00101011", nullptr, 2), "aload_1" },
			{ std::stoi("00101100", nullptr, 2), "aload_2" },
			{ std::stoi("00101101", nullptr, 2), "aload_3" },
			{ std::stoi("10111101", nullptr, 2), "anewarray" },
			{ std::stoi("10110000", nullptr, 2), "areturn" },
			{ std::stoi("10111110", nullptr, 2), "arraylength" },
			{ std::stoi("00111010", nullptr, 2), "astore" },
			{ std::stoi("01001011", nullptr, 2), "astore_0" },
			{ std::stoi("01001100", nullptr, 2), "astore_1" },
			{ std::stoi("01001101", nullptr, 2), "astore_2" },
			{ std::stoi("01001110", nullptr, 2), "astore_3" },
			{ std::stoi("10111111", nullptr, 2), "athrow" },
			{ std::stoi("00110011", nullptr, 2), "baload" },
			{ std::stoi("01010100", nullptr, 2), "bastore" },
			{ std::stoi("00010000", nullptr, 2), "bipush" },
			{ std::stoi("11001010", nullptr, 2), "breakpoint" },
			{ std::stoi("00110100", nullptr, 2), "caload" },
			{ std::stoi("01010101", nullptr, 2), "castore" },
			{ std::stoi("11000000", nullptr, 2), "checkcast" },
			{ std::stoi("10010000", nullptr, 2), "d2f" },
			{ std::stoi("10001110", nullptr, 2), "d2i" },
			{ std::stoi("10001111", nullptr, 2), "d2l" },
			{ std::stoi("01100011", nullptr, 2), "dadd" },
			{ std::stoi("00110001", nullptr, 2), "daload" },
			{ std::stoi("01010010", nullptr, 2), "dastore" },
			{ std::stoi("10011000", nullptr, 2), "dcmpg" },
			{ std::stoi("10010111", nullptr, 2), "dcmpl" },
			{ std::stoi("00001110", nullptr, 2), "dconst_0" },
			{ std::stoi("00001111", nullptr, 2), "dconst_1" },
			{ std::stoi("01101111", nullptr, 2), "ddiv" },
			{ std::stoi("00011000", nullptr, 2), "dload" },
			{ std::stoi("00100110", nullptr, 2), "dload_0" },
			{ std::stoi("00100111", nullptr, 2), "dload_1" },
			{ std::stoi("00101000", nullptr, 2), "dload_2" },
			{ std::stoi("00101001", nullptr, 2), "dload_3" },
			{ std::stoi("01101011", nullptr, 2), "dmul" },
			{ std::stoi("01110111", nullptr, 2), "dneg" },
			{ std::stoi("01110011", nullptr, 2), "drem" },
			{ std::stoi("10101111", nullptr, 2), "dreturn" },
			{ std::stoi("00111001", nullptr, 2), "dstore" },
			{ std::stoi("01000111", nullptr, 2), "dstore_0" },
			{ std::stoi("01001000", nullptr, 2), "dstore_1" },
			{ std::stoi("01001001", nullptr, 2), "dstore_2" },
			{ std::stoi("01001010", nullptr, 2), "dstore_3" },
			{ std::stoi("01100111", nullptr, 2), "dsub" },
			{ std::stoi("01011001", nullptr, 2), "dup" },
			{ std::stoi("01011010", nullptr, 2), "dup_x1" },
			{ std::stoi("01011011", nullptr, 2), "dup_x2" },
			{ std::stoi("01011100", nullptr, 2), "dup2" },
			{ std::stoi("01011101", nullptr, 2), "dup2_x1" },
			{ std::stoi("01011110", nullptr, 2), "dup2_x2" },
			{ std::stoi("10001101", nullptr, 2), "f2d" },
			{ std::stoi("10001011", nullptr, 2), "f2i" },
			{ std::stoi("10001100", nullptr, 2), "f2l" },
			{ std::stoi("01100010", nullptr, 2), "fadd" },
			{ std::stoi("00110000", nullptr, 2), "faload" },
			{ std::stoi("01010001", nullptr, 2), "fastore" },
			{ std::stoi("10010110", nullptr, 2), "fcmpg" },
			{ std::stoi("10010101", nullptr, 2), "fcmpl" },
			{ std::stoi("00001011", nullptr, 2), "fconst_0" },
			{ std::stoi("00001100", nullptr, 2), "fconst_1" },
			{ std::stoi("00001101", nullptr, 2), "fconst_2" },
			{ std::stoi("01101110", nullptr, 2), "fdiv" },
			{ std::stoi("00010111", nullptr, 2), "fload" },
			{ std::stoi("00100010", nullptr, 2), "fload_0" },
			{ std::stoi("00100011", nullptr, 2), "fload_1" },
			{ std::stoi("00100100", nullptr, 2), "fload_2" },
			{ std::stoi("00100101", nullptr, 2), "fload_3" },
			{ std::stoi("01101010", nullptr, 2), "fmul" },
			{ std::stoi("01110110", nullptr, 2), "fneg" },
			{ std::stoi("01110010", nullptr, 2), "frem" },
			{ std::stoi("10101110", nullptr, 2), "freturn" },
			{ std::stoi("00111000", nullptr, 2), "fstore" },
			{ std::stoi("01000011", nullptr, 2), "fstore_0" },
			{ std::stoi("01000100", nullptr, 2), "fstore_1" },
			{ std::stoi("01000101", nullptr, 2), "fstore_2" },
			{ std::stoi("01000110", nullptr, 2), "fstore_3" },
			{ std::stoi("01100110", nullptr, 2), "fsub" },
			{ std::stoi("10110100", nullptr, 2), "getfield" },
			{ std::stoi("10110010", nullptr, 2), "getstatic" },
			{ std::stoi("10100111", nullptr, 2), "goto" },
			{ std::stoi("11001000", nullptr, 2), "goto_w" },
			{ std::stoi("10010001", nullptr, 2), "i2b" },
			{ std::stoi("10010010", nullptr, 2), "i2c" },
			{ std::stoi("10000111", nullptr, 2), "i2d" },
			{ std::stoi("10000110", nullptr, 2), "i2f" },
			{ std::stoi("10000101", nullptr, 2), "i2l" },
			{ std::stoi("10010011", nullptr, 2), "i2s" },
			{ std::stoi("01100000", nullptr, 2), "iadd" },
			{ std::stoi("00101110", nullptr, 2), "iaload" },
			{ std::stoi("01111110", nullptr, 2), "iand" },
			{ std::stoi("01001111", nullptr, 2), "iastore" },
			{ std::stoi("00000010", nullptr, 2), "iconst_m1" },
			{ std::stoi("00000011", nullptr, 2), "iconst_0" },
			{ std::stoi("00000100", nullptr, 2), "iconst_1" },
			{ std::stoi("00000101", nullptr, 2), "iconst_2" },
			{ std::stoi("00000110", nullptr, 2), "iconst_3" },
			{ std::stoi("00000111", nullptr, 2), "iconst_4" },
			{ std::stoi("00001000", nullptr, 2), "iconst_5" },
			{ std::stoi("01101100", nullptr, 2), "idiv" },
			{ std::stoi("10100101", nullptr, 2), "if_acmpeq" },
			{ std::stoi("10100110", nullptr, 2), "if_acmpne" },
			{ std::stoi("10011111", nullptr, 2), "if_icmpeq" },
			{ std::stoi("10100010", nullptr, 2), "if_icmpge" },
			{ std::stoi("10100011", nullptr, 2), "if_icmpgt" },
			{ std::stoi("10100100", nullptr, 2), "if_icmple" },
			{ std::stoi("10100001", nullptr, 2), "if_icmplt" },
			{ std::stoi("10100000", nullptr, 2), "if_icmpne" },
			{ std::stoi("10011001", nullptr, 2), "ifeq" },
			{ std::stoi("10011100", nullptr, 2), "ifge" },
			{ std::stoi("10011101", nullptr, 2), "ifgt" },
			{ std::stoi("10011110", nullptr, 2), "ifle" },
			{ std::stoi("10011011", nullptr, 2), "iflt" },
			{ std::stoi("10011010", nullptr, 2), "ifne" },
			{ std::stoi("11000111", nullptr, 2), "ifnonnull" },
			{ std::stoi("11000110", nullptr, 2), "ifnull" },
			{ std::stoi("10000100", nullptr, 2), "iinc" },
			{ std::stoi("00010101", nullptr, 2), "iload" },
			{ std::stoi("00011010", nullptr, 2), "iload_0" },
			{ std::stoi("00011011", nullptr, 2), "iload_1" },
			{ std::stoi("00011100", nullptr, 2), "iload_2" },
			{ std::stoi("00011101", nullptr, 2), "iload_3" },
			{ std::stoi("11111110", nullptr, 2), "impdep1" },
			{ std::stoi("11111111", nullptr, 2), "impdep2" },
			{ std::stoi("01101000", nullptr, 2), "imul" },
			{ std::stoi("01110100", nullptr, 2), "ineg" },
			{ std::stoi("11000001", nullptr, 2), "instanceof" },
			{ std::stoi("10111010", nullptr, 2), "invokedynamic" },
			{ std::stoi("10111001", nullptr, 2), "invokeinterface" },
			{ std::stoi("10110111", nullptr, 2), "invokespecial" },
			{ std::stoi("10111000", nullptr, 2), "invokestatic" },
			{ std::stoi("10110110", nullptr, 2), "invokevirtual" },
			{ std::stoi("10000000", nullptr, 2), "ior" },
			{ std::stoi("01110000", nullptr, 2), "irem" },
			{ std::stoi("10101100", nullptr, 2), "ireturn" },
			{ std::stoi("01111000", nullptr, 2), "ishl" },
			{ std::stoi("01111010", nullptr, 2), "ishr" },
			{ std::stoi("00110110", nullptr, 2), "istore" },
			{ std::stoi("00111011", nullptr, 2), "istore_0" },
			{ std::stoi("00111100", nullptr, 2), "istore_1" },
			{ std::stoi("00111101", nullptr, 2), "istore_2" },
			{ std::stoi("00111110", nullptr, 2), "istore_3" },
			{ std::stoi("01100100", nullptr, 2), "isub" },
			{ std::stoi("01111100", nullptr, 2), "iushr" },
			{ std::stoi("10000010", nullptr, 2), "ixor" },
			{ std::stoi("10101000", nullptr, 2), "jsr" },
			{ std::stoi("11001001", nullptr, 2), "jsr_w" },
			{ std::stoi("10001010", nullptr, 2), "l2d" },
			{ std::stoi("10001001", nullptr, 2), "l2f" },
			{ std::stoi("10001000", nullptr, 2), "l2i" },
			{ std::stoi("01100001", nullptr, 2), "ladd" },
			{ std::stoi("00101111", nullptr, 2), "laload" },
			{ std::stoi("01111111", nullptr, 2), "land" },
			{ std::stoi("01010000", nullptr, 2), "lastore" },
			{ std::stoi("10010100", nullptr, 2), "lcmp" },
			{ std::stoi("00001001", nullptr, 2), "lconst_0" },
			{ std::stoi("00001010", nullptr, 2), "lconst_1" },
			{ std::stoi("00010010", nullptr, 2), "ldc" },
			{ std::stoi("00010011", nullptr, 2), "ldc_w" },
			{ std::stoi("00010100", nullptr, 2), "ldc2_w" },
			{ std::stoi("01101101", nullptr, 2), "ldiv" },
			{ std::stoi("00010110", nullptr, 2), "lload" },
			{ std::stoi("00011110", nullptr, 2), "lload_0" },
			{ std::stoi("00011111", nullptr, 2), "lload_1" },
			{ std::stoi("00100000", nullptr, 2), "lload_2" },
			{ std::stoi("00100001", nullptr, 2), "lload_3" },
			{ std::stoi("01101001", nullptr, 2), "lmul" },
			{ std::stoi("01110101", nullptr, 2), "lneg" },
			{ std::stoi("10101011", nullptr, 2), "lookupswitch" },
			{ std::stoi("10000001", nullptr, 2), "lor" },
			{ std::stoi("01110001", nullptr, 2), "lrem" },
			{ std::stoi("10101101", nullptr, 2), "lreturn" },
			{ std::stoi("01111001", nullptr, 2), "lshl" },
			{ std::stoi("01111011", nullptr, 2), "lshr" },
			{ std::stoi("00110111", nullptr, 2), "lstore" },
			{ std::stoi("00111111", nullptr, 2), "lstore_0" },
			{ std::stoi("01000000", nullptr, 2), "lstore_1" },
			{ std::stoi("01000001", nullptr, 2), "lstore_2" },
			{ std::stoi("01000010", nullptr, 2), "lstore_3" },
			{ std::stoi("01100101", nullptr, 2), "lsub" },
			{ std::stoi("01111101", nullptr, 2), "lushr" },
			{ std::stoi("10000011", nullptr, 2), "lxor" },
			{ std::stoi("11000010", nullptr, 2), "monitorenter" },
			{ std::stoi("11000011", nullptr, 2), "monitorexit" },
			{ std::stoi("11000101", nullptr, 2), "multianewarray" },
			{ std::stoi("10111011", nullptr, 2), "new" },
			{ std::stoi("10111100", nullptr, 2), "newarray" },
			{ std::stoi("00000000", nullptr, 2), "nop" },
			{ std::stoi("01010111", nullptr, 2), "pop" },
			{ std::stoi("01011000", nullptr, 2), "pop2" },
			{ std::stoi("10110101", nullptr, 2), "putfield" },
			{ std::stoi("10110011", nullptr, 2), "putstatic" },
			{ std::stoi("10101001", nullptr, 2), "ret" },
			{ std::stoi("10110001", nullptr, 2), "return" },
			{ std::stoi("00110101", nullptr, 2), "saload" },
			{ std::stoi("01010110", nullptr, 2), "sastore" },
			{ std::stoi("00010001", nullptr, 2), "sipush" },
			{ std::stoi("01011111", nullptr, 2), "swap" },
			{ std::stoi("10101010", nullptr, 2), "tableswitch" },
			{ std::stoi("11000100", nullptr, 2), "wide" }
		};

		char buffer[5];
		auto& name = cp[name_index.value.number]->as<CP_Utf8>();

		os << name << std::endl;
		os << tabs << "\tLength: " << length.value.number << std::endl;

		if (name_index.value.number == 12) { // Code
			os << tabs << "\tInstruction:" << std::endl;
			for (auto byte : info) {
				os << tabs << "\t\t" << code[byte] << std::endl;
			}
		} else {
			os << tabs << "\tBytes: ";

			for (auto& byte : info) {
				sprintf(buffer, "%.2X ", byte);
				os << buffer;
			}

			os << std::endl;
		}
	}

	void AttributeInfo::Read(Reader &reader) {
		name_index = reader.getNextHalfWord();
		length = reader.getNextWord();

		for (int i = 0; i < length.value.number; ++i) {
			info.push_back(reader.getNextByte().value.number);
		}
	}
}
